<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>设置</title>
    <style>
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0; background: #f6f7fb;
        }
        body {
            font-family: 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Arial', sans-serif;
            color: #222;
            overflow: hidden;
        }
        .settings-root {
            width: 100vw; height: 100vh;
            display: flex;
            flex-direction: column;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }
        .settings-header {
            height: 60px;
            background: #f6f7fb;
            border-bottom: 1px solid #ececec;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            -webkit-app-region: drag;
        }
        .settings-header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #222;
        }
        .settings-header .close-btn {
            width: 32px;
            height: 32px;
            background: rgba(180,180,180,0.08);
            border: none;
            border-radius: 50%;
            color: #888;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            -webkit-app-region: no-drag;
        }
        .settings-header .close-btn:hover {
            background: rgba(180,180,180,0.18);
            color: #222;
        }
        .settings-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .settings-sidebar {
            width: 160px;
            background: #f6f7fb;
            border-right: 1px solid #ececec;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding-top: 16px;
        }
        .settings-sidebar .menu-item {
            width: 100%;
            padding: 12px 24px;
            font-size: 16px;
            color: #666;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            border-radius: 6px 0 0 6px;
            margin-bottom: 4px;
            transition: background 0.2s, color 0.2s;
        }
        .settings-sidebar .menu-item.active, .settings-sidebar .menu-item:hover {
            background: #e3e7f0;
            color: #222;
        }
        .settings-content {
            flex: 1;
            padding: 32px;
            position: relative;
            overflow-y: auto;
        }
        .settings-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 24px;
        }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-size: 15px; color: #444; }
        select, input[type="text"], input[type="file"], textarea { 
            width: 100%; 
            padding: 7px 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-size: 15px; 
            background: #fafbfc; 
        }
        select:focus, input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }
        .model-selector {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        .model-selector select {
            flex: 1;
        }
        .model-selector button {
            padding: 7px 12px;
            border: none;
            border-radius: 5px;
            background: #4a90e2;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .model-selector button:hover {
            background: #357abd;
        }
        .part-list { margin: 0; padding: 0; list-style: none; }
        .part-list li { 
            display: flex; 
            align-items: center; 
            margin-bottom: 8px; 
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .part-list input[type="text"] { flex: 1; margin-right: 8px; }
        .part-list .part-name { width: 120px; }
        .part-list .part-tip { flex: 1; }
        .add-part-btn { 
            margin-top: 8px; 
            padding: 8px 16px; 
            border: none; 
            border-radius: 5px; 
            background: #e3e7f0; 
            color: #333; 
            cursor: pointer; 
            font-size: 14px;
            transition: background 0.2s;
        }
        .add-part-btn:hover { background: #d0d6e1; }
        .remove-part-btn { 
            background: none; 
            border: none; 
            color: #c00; 
            font-size: 18px; 
            cursor: pointer; 
            margin-left: 4px;
            padding: 4px;
            border-radius: 3px;
            transition: background 0.2s;
        }
        .remove-part-btn:hover {
            background: rgba(204, 0, 0, 0.1);
        }
        .builtin-parts {
            margin-bottom: 16px;
            padding: 12px;
            background: #f0f7ff;
            border-radius: 6px;
            border-left: 4px solid #4a90e2;
        }
        .builtin-parts h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #4a90e2;
        }
        .builtin-parts .part-list li {
            background: white;
            margin-bottom: 4px;
        }
        .custom-parts {
            margin-top: 16px;
        }
        .custom-parts h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #666;
        }
        .btn-danger {
            background: #f5eaea !important;
            color: #c00 !important;
        }
        .btn-danger:hover {
            background: #f0e0e0 !important;
        }
    </style>
</head>
<body>
    <div class="settings-root">
        <div class="settings-header">
            <h1>设置</h1>
            <button class="close-btn" id="close-settings">×</button>
        </div>
        <div class="settings-body">
            <div class="settings-sidebar">
                <button class="menu-item active" data-section="model">3D模型</button>
                <button class="menu-item" data-section="scene">3D场景</button>
            </div>
            <div class="settings-content" id="settings-content">
                <div class="settings-title">3D模型设置</div>
                <div id="settings-section-content"></div>
            </div>
        </div>
    </div>
    <script type="module">
        // --- 工具函数 ---
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        };

        // --- DOM 引用 ---
        const closeButton = document.getElementById('close-settings');
        const menuItems = document.querySelectorAll('.menu-item');
        const sectionContent = document.getElementById('settings-section-content');
        const title = document.querySelector('.settings-title');

        // --- 全局状态 ---
        let config = {};
        let currentSection = 'model';
        let availableModels = [
            { name: '默认模型', path: '../../assets/default.vrm' },
            { name: 'FoxGirl', path: '../../assets/FoxGirl.vrm' },
            { name: '冨美江', path: '../../assets/冨美江.vrm' }
        ];
        
        const sectionMap = {
            model: { title: '3D模型设置', render: renderModelSection },
            scene: { title: '3D场景设置', render: renderSceneSection },
        };

        // 内置部位提示
        const builtinPartTips = [
            { name: 'head', tip: '头部' },
            { name: 'arms', tip: '手臂' },
            { name: 'legs', tip: '腿部' },
            { name: 'chest', tip: '胸部' },
            { name: 'belly', tip: '腹部' },
            { name: 'hips', tip: '臀部' }
        ];

        // --- 初始化和配置管理 ---
        const saveConfig = debounce(() => {
            window.electronAPI && window.electronAPI.setConfig(config);
        }, 300);

        async function loadConfigAndRender() {
            config = (await window.electronAPI.getConfig()) || {};
            // 确保配置对象中有基本结构
            config.model = config.model || {};
            config.scene = config.scene || {};
            config.model.partTips = config.model.partTips || [];
            config.model.customModels = config.model.customModels || [];

            // 加载自定义模型到可用模型列表
            if (config.model.customModels) {
                availableModels = [
                    ...availableModels,
                    ...config.model.customModels.map(model => ({
                        name: model.name,
                        path: model.path
                    }))
                ];
            }

            renderCurrentSection();
        }

        function renderCurrentSection() {
            title.textContent = sectionMap[currentSection].title;
            sectionContent.innerHTML = ''; // 清空内容
            sectionMap[currentSection].render(sectionContent);
        }

        // --- 事件监听 ---
        closeButton.onclick = () => {
            window.electronAPI && window.electronAPI.closeSettings();
        };

        menuItems.forEach(item => {
            item.onclick = () => {
                menuItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                currentSection = item.getAttribute('data-section');
                renderCurrentSection();
            };
        });
        
        // 恢复默认配置
        async function resetConfig() {
            if(confirm('确定要恢复所有默认设置吗？自定义上传的文件不会被删除。')){
                await window.electronAPI.resetConfig();
                await loadConfigAndRender();
            }
        }

        // --- 渲染函数：模型设置 ---
        function renderModelSection(container) {
            const currentModel = availableModels.find(m => m.path === config.modelPath) || 
                               { name: '自定义模型', path: config.modelPath };
            
            container.innerHTML = `
                <div class="form-group">
                    <label>选择模型</label>
                    <div class="model-selector">
                        <select id="model-select">
                            ${availableModels.map(model => 
                                `<option value="${model.path}" ${model.path === config.modelPath ? 'selected' : ''}>
                                    ${model.name}
                                </option>`
                            ).join('')}
                            ${!availableModels.find(m => m.path === config.modelPath) && config.modelPath ? 
                                `<option value="${config.modelPath}" selected>自定义模型</option>` : ''
                            }
                        </select>
                        <button id="add-custom-model-btn">添加自定义模型</button>
                    </div>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 24px 0;" />
                <div class="builtin-parts">
                    <h4>部位提示（仅可编辑内容）</h4>
                    <ul class="part-list" id="builtin-part-list"></ul>
                </div>
                <div style="text-align:right;margin-top:32px;">
                    <button class="add-part-btn btn-danger" id="reset-btn">恢复所有默认</button>
                </div>
            `;

            // 渲染部位提示
            const builtinPartList = container.querySelector('#builtin-part-list');
            // 读取配置中的自定义内容
            let userTips = (config.model && config.model.partTips) ? config.model.partTips : [];
            // 以内置顺序渲染
            builtinPartTips.forEach((part, index) => {
                // 查找用户自定义内容
                let userTip = userTips.find(t => t.name === part.name);
                let tipValue = userTip ? userTip.tip : part.tip;
                const li = document.createElement('li');
                li.innerHTML = `
                    <input type="text" value="${part.name}" class="part-name" readonly style="background:#f5f5f5;" />
                    <input type="text" value="${tipValue}" class="part-tip" placeholder="对应提示语" data-builtin-index="${index}" />
                `;
                builtinPartList.appendChild(li);
            });

            // 只允许编辑内容
            container.querySelectorAll('[data-builtin-index]').forEach(input => {
                input.oninput = (e) => {
                    const index = parseInt(e.target.dataset.builtinIndex, 10);
                    const part = builtinPartTips[index];
                    // 更新到配置
                    if (!config.model.partTips) config.model.partTips = [];
                    let userTip = config.model.partTips.find(t => t.name === part.name);
                    if (!userTip) {
                        userTip = { name: part.name, tip: '' };
                        config.model.partTips.push(userTip);
                    }
                    userTip.tip = e.target.value;
                    saveConfig();
                };
            });
            container.querySelector('#reset-btn').onclick = resetConfig;
        }

        function renderSceneSection(container) {
            const isCustomStage = config.scene?.stagePath;

            container.innerHTML = `
                <div class="form-group">
                    <label>当前舞台模型</label>
                    <p style="font-size:14px; word-break:break-all; background: #f0f0f0; padding: 8px; border-radius: 4px;">${config.scene?.stagePath || '无舞台 (透明背景)'}</p>
                </div>
                 <div style="text-align:right;margin-top:32px;">
                    <button class="add-part-btn btn-danger" id="reset-btn">恢复所有默认</button>
                </div>
            `;

            container.querySelector('#stage-upload').onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const relativePath = await window.electronAPI.copyToAssets(file.path);
                    if (isCustomStage) {
                        await window.electronAPI.deleteFromAssets(config.scene.stagePath);
                    }
                    if(!config.scene) config.scene = {};
                    config.scene.stagePath = relativePath;
                    saveConfig();
                    renderCurrentSection();
                } catch (error) {
                    alert('舞台上传失败');
                }
            };
            
            if (isCustomStage) {
                container.querySelector('#remove-custom-stage-btn').onclick = async () => {
                    if (confirm('确定要移除自定义舞台吗？')) {
                        await window.electronAPI.deleteFromAssets(config.scene.stagePath);
                        delete config.scene.stagePath;
                        saveConfig();
                        renderCurrentSection();
                    }
                };
            }
            
            container.querySelector('#reset-btn').onclick = resetConfig;
        }

        // --- 初始加载 ---
        loadConfigAndRender();
    </script>
</body>
</html> 