<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>设置</title>
    <style>
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0; background: #f6f7fb;
        }
        body {
            font-family: 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Arial', sans-serif;
            color: #222;
            overflow: hidden;
        }
        .settings-root {
            width: 100vw; height: 100vh;
            display: flex;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }
        .settings-sidebar {
            width: 160px;
            background: #f6f7fb;
            border-right: 1px solid #ececec;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding-top: 48px;
            position: relative;
            -webkit-app-region: drag;
        }
        .settings-sidebar .menu-item {
            width: 100%;
            padding: 12px 24px;
            font-size: 16px;
            color: #666;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            border-radius: 6px 0 0 6px;
            margin-bottom: 4px;
            transition: background 0.2s, color 0.2s;
        }
        .settings-sidebar .menu-item.active, .settings-sidebar .menu-item:hover {
            background: #e3e7f0;
            color: #222;
        }
        .settings-content {
            flex: 1;
            padding: 48px 32px 32px 32px;
            position: relative;
            overflow-y: auto;
        }
        .settings-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 24px;
        }
        .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 36px;
            height: 36px;
            background: rgba(180,180,180,0.08);
            border: none;
            border-radius: 50%;
            color: #888;
            font-size: 22px;
            cursor: pointer;
            z-index: 10;
            transition: background 0.2s, color 0.2s;
            -webkit-app-region: no-drag;
        }
        .close-btn:hover {
            background: rgba(180,180,180,0.18);
            color: #222;
        }
        /* 拖拽区域 */
        .settings-drag-bar {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 40px;
            -webkit-app-region: drag;
            z-index: 2;
        }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-size: 15px; color: #444; }
        select, input[type="text"], input[type="file"], textarea { width: 100%; padding: 7px 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 15px; background: #fafbfc; }
        .part-list { margin: 0; padding: 0; list-style: none; }
        .part-list li { display: flex; align-items: center; margin-bottom: 8px; }
        .part-list input[type="text"] { flex: 1; margin-right: 8px; }
        .add-part-btn { margin-top: 8px; padding: 5px 12px; border: none; border-radius: 5px; background: #e3e7f0; color: #333; cursor: pointer; font-size: 14px; }
        .add-part-btn:hover { background: #d0d6e1; }
        .remove-part-btn { background: none; border: none; color: #c00; font-size: 18px; cursor: pointer; margin-left: 4px; }
    </style>
</head>
<body>
    <div class="settings-root">
        <div class="settings-sidebar">
            <div class="settings-drag-bar"></div>
            <button class="menu-item active" data-section="model">3D模型</button>
            <button class="menu-item" data-section="scene">3D场景</button>
        </div>
        <div class="settings-content" id="settings-content">
            <div class="settings-title">3D模型设置</div>
            <div id="settings-section-content"></div>
        </div>
        <button class="close-btn" id="close-settings">×</button>
    </div>
    <script type="module">
        // --- 工具函数 ---
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        };

        // --- DOM 引用 ---
        const closeButton = document.getElementById('close-settings');
        const menuItems = document.querySelectorAll('.menu-item');
        const sectionContent = document.getElementById('settings-section-content');
        const title = document.querySelector('.settings-title');

        // --- 全局状态 ---
        let config = {};
        let currentSection = 'model';
        const sectionMap = {
            model: { title: '3D模型设置', render: renderModelSection },
            scene: { title: '3D场景设置', render: renderSceneSection },
        };

        // --- 初始化和配置管理 ---
        const saveConfig = debounce(() => {
            window.electronAPI && window.electronAPI.setConfig(config);
        }, 300);

        async function loadConfigAndRender() {
            config = (await window.electronAPI.getConfig()) || {};
            // 确保配置对象中有基本结构
            config.model = config.model || {};
            config.scene = config.scene || {};
            config.model.partTips = config.model.partTips || [];

            renderCurrentSection();
        }

        function renderCurrentSection() {
            title.textContent = sectionMap[currentSection].title;
            sectionContent.innerHTML = ''; // 清空内容
            sectionMap[currentSection].render(sectionContent);
        }

        // --- 事件监听 ---
        closeButton.onclick = () => {
            window.electronAPI && window.electronAPI.closeSettings();
        };

        menuItems.forEach(item => {
            item.onclick = () => {
                menuItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                currentSection = item.getAttribute('data-section');
                renderCurrentSection();
            };
        });
        
        // 恢复默认配置
        async function resetConfig() {
            if(confirm('确定要恢复所有默认设置吗？自定义上传的文件不会被删除。')){
                await window.electronAPI.resetConfig();
                await loadConfigAndRender();
            }
        }

        // --- 渲染函数：模型设置 ---
        function renderModelSection(container) {
            const isCustomModel = config.modelPath && !config.modelPath.includes('default.vrm');
            
            container.innerHTML = `
                <div class="form-group">
                    <label>当前模型</label>
                    <p style="font-size:14px; word-break:break-all; background: #f0f0f0; padding: 8px; border-radius: 4px;">${config.modelPath || '未设置'}</p>
                </div>
                <div class="form-group">
                    <label>选择新模型 (.vrm)</label>
                    <input type="file" id="model-upload" accept=".vrm" style="display: block;"/>
                    <button id="set-default-model-btn" class="add-part-btn" style="margin-top: 8px;">使用内置模型</button>
                    ${isCustomModel ? '<button id="delete-custom-model-btn" class="add-part-btn" style="margin-top: 8px; background:#f5eaea;color:#c00;">删除当前自定义模型</button>' : ''}
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 24px 0;" />
                <div class="form-group">
                    <label>自定义部位提示</label>
                    <ul class="part-list" id="part-list-container"></ul>
                    <button class="add-part-btn" id="add-part-btn">添加部位</button>
                </div>
                <div style="text-align:right;margin-top:32px;">
                    <button class="add-part-btn" id="reset-btn" style="background:#f5eaea;color:#c00;">恢复所有默认</button>
                </div>
            `;

            const partListContainer = container.querySelector('#part-list-container');
            (config.model.partTips || []).forEach((part, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <input type="text" value="${part.name || ''}" class="part-name" placeholder="部位名(如:head)" style="width:80px;" data-index="${index}" />
                    <input type="text" value="${part.tip || ''}" class="part-tip" placeholder="对应提示语" data-index="${index}" />
                    <button class="remove-part-btn" title="删除" data-index="${index}">×</button>
                `;
                partListContainer.appendChild(li);
            });

            // --- 事件绑定 ---
            container.querySelector('#model-upload').onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const relativePath = await window.electronAPI.copyToAssets(file.path);
                    if (isCustomModel) {
                         await window.electronAPI.deleteFromAssets(config.modelPath);
                    }
                    config.modelPath = relativePath;
                    saveConfig();
                    renderCurrentSection();
                } catch (error) {
                    console.error('上传失败', error);
                    alert('模型上传失败，请查看控制台日志。');
                }
            };
            
            container.querySelector('#set-default-model-btn').onclick = async () => {
                 if (isCustomModel) {
                    await window.electronAPI.deleteFromAssets(config.modelPath);
                }
                config.modelPath = '../../assets/default.vrm';
                saveConfig();
                renderCurrentSection();
            };

            if(isCustomModel) {
                container.querySelector('#delete-custom-model-btn').onclick = async () => {
                    if (confirm('确定要删除这个自定义模型文件吗？此操作不可恢复。')) {
                        await window.electronAPI.deleteFromAssets(config.modelPath);
                        config.modelPath = '../../assets/default.vrm';
                        saveConfig();
                        renderCurrentSection();
                    }
                };
            }

            container.querySelector('#add-part-btn').onclick = () => {
                if (!config.model.partTips) config.model.partTips = [];
                config.model.partTips.push({ name: '', tip: '' });
                renderCurrentSection();
            };

            container.querySelectorAll('.remove-part-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    config.model.partTips.splice(index, 1);
                    saveConfig();
                    renderCurrentSection();
                };
            });
            
            container.querySelectorAll('.part-name, .part-tip').forEach(input => {
                input.oninput = (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    const key = e.target.classList.contains('part-name') ? 'name' : 'tip';
                    config.model.partTips[index][key] = e.target.value;
                    saveConfig();
                };
            });
            
            container.querySelector('#reset-btn').onclick = resetConfig;
        }

        function renderSceneSection(container) {
            const isCustomStage = config.scene?.stagePath;

            container.innerHTML = `
                <div class="form-group">
                    <label>当前舞台模型</label>
                    <p style="font-size:14px; word-break:break-all; background: #f0f0f0; padding: 8px; border-radius: 4px;">${config.scene?.stagePath || '无舞台 (透明背景)'}</p>
                </div>
                <div class="form-group">
                    <label>上传新舞台 (.gltf, .glb)</label>
                    <input type="file" id="stage-upload" accept=".gltf,.glb" style="display: block;"/>
                    <button id="remove-custom-stage-btn" class="add-part-btn" style="margin-top: 8px; ${!isCustomStage ? 'display:none;' : ''}"">移除自定义舞台</button>
                </div>
                 <div style="text-align:right;margin-top:32px;">
                    <button class="add-part-btn" id="reset-btn" style="background:#f5eaea;color:#c00;">恢复所有默认</button>
                </div>
            `;

            container.querySelector('#stage-upload').onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const relativePath = await window.electronAPI.copyToAssets(file.path);
                    if (isCustomStage) {
                        await window.electronAPI.deleteFromAssets(config.scene.stagePath);
                    }
                    if(!config.scene) config.scene = {};
                    config.scene.stagePath = relativePath;
                    saveConfig();
                    renderCurrentSection();
                } catch (error) {
                    alert('舞台上传失败');
                }
            };
            
            if (isCustomStage) {
                container.querySelector('#remove-custom-stage-btn').onclick = async () => {
                    if (confirm('确定要移除自定义舞台吗？')) {
                        await window.electronAPI.deleteFromAssets(config.scene.stagePath);
                        delete config.scene.stagePath;
                        saveConfig();
                        renderCurrentSection();
                    }
                };
            }
            
            container.querySelector('#reset-btn').onclick = resetConfig;
        }

        // --- 初始加载 ---
        loadConfigAndRender();
    </script>
</body>
</html> 