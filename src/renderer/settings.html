<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>设置</title>
    <style>
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0; background: #f6f7fb;
        }
        body {
            font-family: 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Arial', sans-serif;
            color: #222;
            overflow: hidden;
        }
        .settings-root {
            width: 100vw; height: 100vh;
            display: flex;
            flex-direction: column;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }
        .settings-header {
            height: 60px;
            background: #f6f7fb;
            border-bottom: 1px solid #ececec;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            -webkit-app-region: drag;
        }
        .settings-header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #222;
        }
        .settings-header .close-btn {
            width: 32px;
            height: 32px;
            background: rgba(180,180,180,0.08);
            border: none;
            border-radius: 50%;
            color: #888;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            -webkit-app-region: no-drag;
        }
        .settings-header .close-btn:hover {
            background: rgba(180,180,180,0.18);
            color: #222;
        }
        .settings-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .settings-sidebar {
            width: 160px;
            background: #f6f7fb;
            border-right: 1px solid #ececec;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding-top: 16px;
        }
        .settings-sidebar .menu-item {
            width: 100%;
            padding: 12px 24px;
            font-size: 16px;
            color: #666;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            border-radius: 6px 0 0 6px;
            margin-bottom: 4px;
            transition: background 0.2s, color 0.2s;
        }
        .settings-sidebar .menu-item.active, .settings-sidebar .menu-item:hover {
            background: #e3e7f0;
            color: #222;
        }
        .settings-content {
            flex: 1;
            padding: 32px;
            position: relative;
            overflow-y: auto;
        }
        .settings-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 24px;
        }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 6px; font-size: 15px; color: #444; }
        select, input[type="text"], input[type="file"], textarea { 
            width: 100%; 
            padding: 7px 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-size: 15px; 
            background: #fafbfc; 
        }
        select:focus, input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }
        .model-selector {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        .model-selector select {
            flex: 1;
        }
        .model-selector button {
            padding: 7px 12px;
            border: none;
            border-radius: 5px;
            background: #4a90e2;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .model-selector button:hover {
            background: #357abd;
        }
        .part-list { margin: 0; padding: 0; list-style: none; }
        .part-list li { 
            display: flex; 
            align-items: center; 
            margin-bottom: 8px; 
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .part-list input[type="text"] { flex: 1; margin-right: 8px; }
        .part-list .part-name { width: 120px; }
        .part-list .part-tip { flex: 1; }
        .add-part-btn { 
            margin-top: 8px; 
            padding: 8px 16px; 
            border: none; 
            border-radius: 5px; 
            background: #e3e7f0; 
            color: #333; 
            cursor: pointer; 
            font-size: 14px;
            transition: background 0.2s;
        }
        .add-part-btn:hover { background: #d0d6e1; }
        .remove-part-btn { 
            background: none; 
            border: none; 
            color: #c00; 
            font-size: 18px; 
            cursor: pointer; 
            margin-left: 4px;
            padding: 4px;
            border-radius: 3px;
            transition: background 0.2s;
        }
        .remove-part-btn:hover {
            background: rgba(204, 0, 0, 0.1);
        }
        .builtin-parts {
            margin-bottom: 16px;
            padding: 12px;
            background: #f0f7ff;
            border-radius: 6px;
            border-left: 4px solid #4a90e2;
        }
        .builtin-parts h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #4a90e2;
        }
        .builtin-parts .part-list li {
            background: white;
            margin-bottom: 4px;
        }
        .custom-parts {
            margin-top: 16px;
        }
        .custom-parts h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #666;
        }
        .btn-danger {
            background: #f5eaea !important;
            color: #c00 !important;
        }
        .btn-danger:hover {
            background: #f0e0e0 !important;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            vertical-align: middle;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .switch input:checked + .slider {
            background-color: #4a90e2;
        }
        .switch input:checked + .slider:before {
            transform: translateX(20px);
        }
        .setting-card {
            background: #fafdff;
            border: 1.5px solid #e3e7f0;
            border-radius: 8px;
            padding: 18px 20px 10px 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(74,144,226,0.04);
        }
        .setting-card .setting-title {
            font-size: 15px;
            color: #4a90e2;
            font-weight: 600;
            margin-bottom: 12px;
            border-bottom: 1px solid #e3e7f0;
            padding-bottom: 6px;
        }
        .setting-card .form-group:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="settings-root">
        <div class="settings-header">
            <h1>设置</h1>
            <button class="close-btn" id="close-settings">×</button>
        </div>
        <div class="settings-body">
            <div class="settings-sidebar">
                <button class="menu-item active" data-section="model">3D模型</button>
                <button class="menu-item" data-section="scene">3D场景</button>
            </div>
            <div class="settings-content" id="settings-content">
                <div class="settings-title">3D模型设置</div>
                <div id="settings-section-content"></div>
            </div>
        </div>
    </div>
    <script type="module">
        // --- 工具函数 ---
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        };

        // --- DOM 引用 ---
        const closeButton = document.getElementById('close-settings');
        const menuItems = document.querySelectorAll('.menu-item');
        const sectionContent = document.getElementById('settings-section-content');
        const title = document.querySelector('.settings-title');

        // --- 全局状态 ---
        let config = {};
        let currentSection = 'model';
        let availableModels = [
            { name: '默认模型', path: '../../assets/default.vrm' },
            { name: 'FoxGirl', path: '../../assets/FoxGirl.vrm' },
            { name: '冨美江', path: '../../assets/冨美江.vrm' }
        ];
        // 新增：记录初始配置用于临时切换
        let originalConfig = null;
        // 动作列表（可根据实际支持扩展）
        const availableActions = [
            { name: '待机', value: 'idle' },
            { name: '随机循环', value: 'random_cycle' },
            { name: '走路', value: 'walk' },
            { name: '跑步', value: 'run' },
            { name: '跳跃', value: 'jump' },
            { name: '挥手', value: 'wave' },
            { name: '跳舞', value: 'dance' },
            { name: '胜利', value: 'victory' },
            { name: '失败', value: 'defeat' }
        ];
        
        const sectionMap = {
            model: { title: '3D模型设置', render: renderModelSection },
            scene: { title: '3D场景设置', render: renderSceneSection },
        };

        // 内置部位提示
        const builtinPartTips = [
            { name: 'head', tip: '头部' },
            { name: 'arms', tip: '手臂' },
            { name: 'legs', tip: '腿部' },
            { name: 'chest', tip: '胸部' },
            { name: 'belly', tip: '腹部' },
            { name: 'hips', tip: '臀部' }
        ];

        // --- 初始化和配置管理 ---
        const saveConfig = debounce(() => {
            window.electronAPI && window.electronAPI.setConfig(config);
        }, 300);

        async function loadConfigAndRender() {
            config = (await window.electronAPI.getConfig()) || {};
            // 记录初始配置
            if (!originalConfig) originalConfig = JSON.parse(JSON.stringify(config));
            // 确保配置对象中有基本结构
            config.model = config.model || {};
            config.scene = config.scene || {};
            config.model.partTips = config.model.partTips || [];
            config.model.customModels = config.model.customModels || [];

            // 加载自定义模型到可用模型列表
            if (config.model.customModels) {
                availableModels = [
                    ...availableModels,
                    ...config.model.customModels.map(model => ({
                        name: model.name,
                        path: model.path
                    }))
                ];
            }

            renderCurrentSection();
        }

        function renderCurrentSection() {
            title.textContent = sectionMap[currentSection].title;
            sectionContent.innerHTML = ''; // 清空内容
            sectionMap[currentSection].render(sectionContent);
        }

        // --- 事件监听 ---
        closeButton.onclick = () => {
            // 恢复原始配置（未保存时）
            if (originalConfig) {
                window.electronAPI.setConfig(originalConfig);
            }
            window.electronAPI && window.electronAPI.closeSettings();
        };

        menuItems.forEach(item => {
            item.onclick = () => {
                menuItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                currentSection = item.getAttribute('data-section');
                renderCurrentSection();
            };
        });
        
        // 恢复默认配置
        async function resetConfig() {
            if(confirm('确定要恢复所有默认设置吗？自定义上传的文件不会被删除。')){
                await window.electronAPI.resetConfig();
                config = (await window.electronAPI.getConfig()) || {};
                originalConfig = JSON.parse(JSON.stringify(config));
                renderCurrentSection(); // 刷新UI控件
                // 主动同步到主窗口，确保3D状态实时变更
                window.electronAPI.setConfig(config);
            }
        }

        // --- 渲染函数：模型设置 ---
        function renderModelSection(container) {
            const currentModel = availableModels.find(m => m.path === config.modelPath) || 
                               { name: '自定义模型', path: config.modelPath };
            
            container.innerHTML = `
                <div class="form-group">
                    <label>选择模型</label>
                    <div class="model-selector">
                        <select id="model-select">
                            ${availableModels.map(model => 
                                `<option value="${model.path}" ${model.path === config.modelPath ? 'selected' : ''}>
                                    ${model.name}
                                </option>`
                            ).join('')}
                            ${!availableModels.find(m => m.path === config.modelPath) && config.modelPath ? 
                                `<option value="${config.modelPath}" selected>自定义模型</option>` : ''
                            }
                        </select>
                        <button id="add-custom-model-btn">添加自定义模型</button>
                    </div>
                </div>
                <div class="setting-card">
                    <div class="setting-title">交互与提示</div>
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;">
                            <span>允许点击模型弹出气泡提示</span>
                            <label class="switch">
                                <input type="checkbox" id="allow-bubble-checkbox" ${config.model.allowBubble !== false ? 'checked' : ''} />
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;">
                            <span>语音播报</span>
                            <label class="switch">
                                <input type="checkbox" id="bubble-tts-checkbox" ${config.model.bubbleTTS ? 'checked' : ''} ${config.model.allowBubble === false ? 'disabled' : ''}/>
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                    <div class="form-group" id="bubble-tts-options" style="margin-top:-10px;${!config.model.bubbleTTS ? 'opacity:0.5;pointer-events:none;' : ''}">
                        <label style="font-size:13px;margin-bottom:4px;">语音类型</label>
                        <select id="bubble-tts-voice" style="width:100%;margin-bottom:8px;"></select>
                        <label style="font-size:13px;">语速 <span id="bubble-tts-rate-value">${config.model.bubbleTTSRate||1}</span></label>
                        <input type="range" id="bubble-tts-rate" min="0.5" max="2" step="0.01" value="${config.model.bubbleTTSRate||1}" style="width:100%;">
                        <label style="font-size:13px;">音量 <span id="bubble-tts-volume-value">${config.model.bubbleTTSVolume||1}</span></label>
                        <input type="range" id="bubble-tts-volume" min="0" max="1" step="0.01" value="${config.model.bubbleTTSVolume||1}" style="width:100%;">
                    </div>
                    <div class="builtin-parts">
                        <h4>内置部位提示</h4>
                        <ul class="part-list" id="builtin-part-list"></ul>
                    </div>
                    <div class="custom-parts">
                        <h4>自定义部位</h4>
                        <ul class="part-list" id="custom-part-list"></ul>
                        <button class="add-part-btn" id="add-custom-part-btn" style="margin-top:8px;">添加自定义部位</button>
                    </div>
                </div>
                <div style="display:flex;justify-content: flex-end;gap:12px;margin-top:32px;">
                    <button class="add-part-btn btn-danger" id="reset-btn">恢复所有默认</button>
                    <button class="add-part-btn" id="save-model-section-btn">保存</button>
                </div>
            `;

            // 渲染部位提示
            const builtinPartList = container.querySelector('#builtin-part-list');
            const customPartList = container.querySelector('#custom-part-list');
            let userTips = (config.model && config.model.partTips) ? config.model.partTips : [];
            // 渲染内置部位
            builtinPartTips.forEach((part, index) => {
                let userTip = userTips.find(t => t.name === part.name);
                let tipValue = userTip ? userTip.tip : part.tip;
                const li = document.createElement('li');
                li.innerHTML = `
                    <span style="width:80px;display:inline-block;">${part.tip}</span>
                    <input type="text" value="${tipValue}" class="part-tip" placeholder="对应提示语" data-builtin-index="${index}" />
                `;
                builtinPartList.appendChild(li);
            });
            // 只允许编辑提示内容
            container.querySelectorAll('[data-builtin-index]').forEach(input => {
                input.oninput = (e) => {
                    const index = parseInt(e.target.dataset.builtinIndex, 10);
                    const part = builtinPartTips[index];
                    if (!config.model.partTips) config.model.partTips = [];
                    let userTip = config.model.partTips.find(t => t.name === part.name);
                    if (!userTip) {
                        userTip = { name: part.name, tip: '' };
                        config.model.partTips.push(userTip);
                    }
                    userTip.tip = e.target.value;
                    saveConfig();
                };
            });
            // 渲染自定义部位
            function renderCustomParts() {
                customPartList.innerHTML = '';
                let customTips = userTips.filter(t => !builtinPartTips.find(b => b.name === t.name));
                // 统计所有事件名
                const allNames = [...builtinPartTips.map(b=>b.name), ...customTips.map(t=>t.name)];
                let nameCount = {};
                allNames.forEach(n => { if(n) nameCount[n] = (nameCount[n]||0)+1; });
                let hasConflict = false;
                customTips.forEach((part, idx) => {
                    const li = document.createElement('li');
                    // 检查是否冲突
                    let isConflict = part.name && nameCount[part.name] > 1;
                    if(isConflict) hasConflict = true;
                    li.innerHTML = `
                        <input type="text" value="${part.name}" class="custom-part-name" placeholder="事件名(英文)" style="width:90px;margin-right:8px;${isConflict?'border:1.5px solid #e00;background:#fff0f0;':''}" />
                        <input type="text" value="${part.cn || ''}" class="custom-part-cn" placeholder="部位名(中文)" style="width:90px;margin-right:8px;" />
                        <input type="text" value="${part.tip || ''}" class="custom-part-tip" placeholder="对应提示语" style="flex:1;margin-right:8px;" />
                        <button class="remove-part-btn" title="删除">×</button>
                    `;
                    // 删除事件
                    li.querySelector('.remove-part-btn').onclick = () => {
                        // 直接用原始数组索引删除，避免因事件名冲突无法删除
                        const allCustom = userTips.filter(t => !builtinPartTips.find(b => b.name === t.name));
                        const realIdx = userTips.indexOf(allCustom[idx]);
                        if(realIdx !== -1) {
                            config.model.partTips.splice(realIdx, 1);
                            saveConfig();
                            renderCustomParts();
                        }
                    };
                    // 编辑事件名
                    li.querySelector('.custom-part-name').oninput = (e) => {
                        const newName = e.target.value.trim();
                        // 检查是否与内置或其他自定义重复
                        let conflict = false;
                        if(newName) {
                            let count = 0;
                            allNames.forEach(n => { if(n===newName) count++; });
                            if(count > 1) conflict = true;
                        }
                        if(conflict) {
                            e.target.style.border = '1.5px solid #e00';
                            e.target.style.background = '#fff0f0';
                            e.target.title = '事件名已存在，不能重复';
                            // 不保存、不重渲染
                        } else {
                            e.target.style.border = '';
                            e.target.style.background = '';
                            e.target.title = '';
                            part.name = newName;
                            saveConfig();
                            // 不重渲染，避免失焦
                        }
                    };
                    // 编辑中文名
                    li.querySelector('.custom-part-cn').oninput = (e) => {
                        part.cn = e.target.value;
                        saveConfig();
                    };
                    // 编辑提示
                    li.querySelector('.custom-part-tip').oninput = (e) => {
                        part.tip = e.target.value;
                        saveConfig();
                    };
                    customPartList.appendChild(li);
                });
                // 添加按钮禁用逻辑
                const addBtn = container.querySelector('#add-custom-part-btn');
                if(hasConflict) {
                    addBtn.disabled = true;
                    addBtn.style.opacity = 0.5;
                    addBtn.title = '有重复事件名，无法添加';
                } else {
                    addBtn.disabled = false;
                    addBtn.style.opacity = 1;
                    addBtn.title = '';
                }
            }
            renderCustomParts();
            // 添加自定义部位
            container.querySelector('#add-custom-part-btn').onclick = () => {
                if (!config.model.partTips) config.model.partTips = [];
                config.model.partTips.push({ name: '', cn: '', tip: '' });
                saveConfig();
                renderCustomParts();
            };

            // 切换模型时临时生效
            container.querySelector('#model-select').onchange = (e) => {
                config.modelPath = e.target.value;
                window.electronAPI.setConfig(config); // 临时生效
            };
            container.querySelector('#reset-btn').onclick = resetConfig;
            container.querySelector('#save-model-section-btn').onclick = async () => {
                // 校验自定义事件名冲突
                let userTips = (config.model && config.model.partTips) ? config.model.partTips : [];
                let customTips = userTips.filter(t => !builtinPartTips.find(b => b.name === t.name));
                let nameMap = {};
                let hasConflict = false;
                customTips.forEach(part => {
                    if (!part.name) return;
                    if (!nameMap[part.name]) nameMap[part.name] = [];
                    nameMap[part.name].push(part);
                });
                // 标记冲突输入框
                const customPartList = container.querySelector('#custom-part-list');
                customPartList.querySelectorAll('.custom-part-name').forEach(input => {
                    const val = input.value.trim();
                    if (val && nameMap[val] && nameMap[val].length > 1) {
                        input.style.border = '1.5px solid #e00';
                        input.style.background = '#fff0f0';
                        input.title = '事件名已存在，不能重复';
                        hasConflict = true;
                    } else {
                        input.style.border = '';
                        input.style.background = '';
                        input.title = '';
                    }
                });
                if (hasConflict) {
                    alert('有重复事件名，请修改后再保存！');
                    return;
                }
                // 保存当前模型设置到数据库
                await window.electronAPI.setConfig(config);
                // 更新原始配置
                originalConfig = JSON.parse(JSON.stringify(config));
                alert('模型设置已保存！');
                // 主动同步到主窗口，确保3D状态实时变更
                window.electronAPI.setConfig(config);
                renderCurrentSection(); // 刷新UI控件
            };

            // 新增：交互开关事件
            container.querySelector('#allow-bubble-checkbox').onchange = (e) => {
                config.model.allowBubble = e.target.checked;
                // 联动语音开关
                const ttsBox = container.querySelector('#bubble-tts-checkbox');
                if(ttsBox) ttsBox.disabled = !e.target.checked;
                saveConfig();
            };

            // 新增：语音播报开关事件
            container.querySelector('#bubble-tts-checkbox').onchange = (e) => {
                config.model.bubbleTTS = e.target.checked;
                // 语音参数面板可用性
                const opts = container.querySelector('#bubble-tts-options');
                if(opts) {
                    if(e.target.checked) {
                        opts.style.opacity = 1;
                        opts.style.pointerEvents = '';
                    } else {
                        opts.style.opacity = 0.5;
                        opts.style.pointerEvents = 'none';
                    }
                }
                saveConfig();
            };

            // 语速、音量事件
            container.querySelector('#bubble-tts-rate').oninput = (e) => {
                config.model.bubbleTTSRate = parseFloat(e.target.value);
                container.querySelector('#bubble-tts-rate-value').innerText = e.target.value;
                saveConfig();
            };
            container.querySelector('#bubble-tts-volume').oninput = (e) => {
                config.model.bubbleTTSVolume = parseFloat(e.target.value);
                container.querySelector('#bubble-tts-volume-value').innerText = e.target.value;
                saveConfig();
            };

            // 语音类型下拉
            const voiceSelect = container.querySelector('#bubble-tts-voice');
            function fillVoices() {
                if(!window.speechSynthesis) return;
                const voices = window.speechSynthesis.getVoices();
                voiceSelect.innerHTML = voices.map(v => `<option value="${v.voiceURI}" ${config.model.bubbleTTSVoice===v.voiceURI?'selected':''}>${v.name} (${v.lang})</option>`).join('');
            }
            if(window.speechSynthesis) {
                window.speechSynthesis.onvoiceschanged = fillVoices;
                fillVoices();
            }
            voiceSelect.onchange = (e) => {
                config.model.bubbleTTSVoice = e.target.value;
                saveConfig();
            };
        }

        // --- 渲染函数：场景设置 ---
        function renderSceneSection(container) {
            const isCustomStage = config.scene?.stagePath;

            container.innerHTML = `
                <div class="form-group">
                    <label>舞台模型</label>
                    <p style="font-size:14px; word-break:break-all; background: #f0f0f0; padding: 8px; border-radius: 4px;">
                        ${isCustomStage ? config.scene.stagePath : '无舞台 (透明背景)'}
                    </p>
                    <div style="margin-top: 8px; display: flex; gap: 8px;">
                        <input type="file" id="stage-upload-input" accept=".glb,.gltf,.vrm" style="display:none;">
                        <button id="stage-upload-btn" class="add-part-btn">上传新舞台</button>
                        ${isCustomStage ? `<button id="remove-stage-btn" class="add-part-btn btn-danger">移除舞台</button>` : ''}
                    </div>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 24px 0;" />
                <div class="form-group">
                    <label>默认动态</label>
                    <select id="scene-action-select">
                        ${availableActions.map(a => `<option value="${a.value}" ${config.action === a.value ? 'selected' : ''}>${a.name}</option>`).join('')}
                    </select>
                    <div id="supported-animations" style="font-size:12px;color:#888;margin-top:6px;"></div>
                </div>
                <div class="form-group">
                    <h4>自定义动作</h4>
                    <p style="font-size:12px; color: #666;">程序会自动加载模型内包含的动画。选择"随机循环"可以在所有可用动画中随机播放。</p>
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin: 24px 0;" />
                <div class="form-group">
                    <label>背景色</label>
                    <input type="color" id="scene-bgcolor" value="${config.appearance?.background && config.appearance.background !== 'transparent' ? config.appearance.background : '#ffffff'}" />
                    <label style="margin-left:8px;"><input type="checkbox" id="scene-bgtrans" ${config.appearance?.background === 'transparent' ? 'checked' : ''}/> 透明背景</label>
                </div>
                <div class="form-group">
                    <label>灯光强度</label>
                    <input type="range" id="scene-light" min="0" max="2" step="0.01" value="${config.scene?.lightIntensity || 1}" />
                    <span id="scene-light-value">${config.scene?.lightIntensity || 1}</span>
                </div>
                <div style="display:flex;justify-content: flex-end;gap:12px;margin-top:32px;">
                    <button class="add-part-btn btn-danger" id="reset-btn">恢复所有默认</button>
                    <button class="add-part-btn" id="save-scene-section-btn">保存</button>
                </div>
            `;

            // --- 场景设置事件监听 ---
            
            // 封装一个函数用于更新配置并触发预览
            const updateConfigAndPreview = () => {
                window.electronAPI.setConfig(config);
            };
            
            // 舞台上传
            const stageUploadBtn = container.querySelector('#stage-upload-btn');
            const stageUploadInput = container.querySelector('#stage-upload-input');
            if (stageUploadBtn && stageUploadInput) {
                stageUploadBtn.onclick = () => stageUploadInput.click();
                stageUploadInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                        const newPath = await window.electronAPI.copyToAssets(file.path);
                        if (!config.scene) config.scene = {};
                        config.scene.stagePath = newPath;
                        updateConfigAndPreview();
                        renderCurrentSection(); // 重新渲染以更新UI
                } catch (error) {
                        alert(`舞台上传失败: ${error.message}`);
                }
            };
            }

            // 移除舞台
            const removeStageBtn = container.querySelector('#remove-stage-btn');
            if (removeStageBtn) {
                removeStageBtn.onclick = async () => {
                    delete config.scene.stagePath;
                    updateConfigAndPreview();
                    renderCurrentSection();
                };
            }
            
            // 动态选择
            container.querySelector('#scene-action-select').onchange = (e) => {
                config.action = e.target.value;
                updateConfigAndPreview();
            };

            // 背景色和透明
            container.querySelector('#scene-bgcolor').oninput = (e) => {
                if (!config.appearance) config.appearance = {};
                config.appearance.background = e.target.value;
                container.querySelector('#scene-bgtrans').checked = false;
                updateConfigAndPreview();
            };
            container.querySelector('#scene-bgtrans').onchange = (e) => {
                if (!config.appearance) config.appearance = {};
                config.appearance.background = e.target.checked ? 'transparent' : container.querySelector('#scene-bgcolor').value;
                updateConfigAndPreview();
            };

            // 灯光强度
            container.querySelector('#scene-light').oninput = (e) => {
                if (!config.scene) config.scene = {};
                config.scene.lightIntensity = parseFloat(e.target.value);
                container.querySelector('#scene-light-value').textContent = e.target.value;
                updateConfigAndPreview();
            };

            // 保存按钮
            container.querySelector('#reset-btn').onclick = resetConfig;
            container.querySelector('#save-scene-section-btn').onclick = async () => {
                await window.electronAPI.setConfig(config);
                originalConfig = JSON.parse(JSON.stringify(config)); // 更新原始配置为已保存状态
                alert('场景设置已保存！');
                // 主动同步到主窗口，确保3D状态实时变更
                window.electronAPI.setConfig(config);
                renderCurrentSection(); // 刷新UI控件
            };

            // 动态显示当前模型支持的动画名
            if(window.electronAPI && window.electronAPI.getConfig){
                window.electronAPI.getConfig().then(cfg=>{
                    if(cfg && cfg._animationNames){
                        container.querySelector('#supported-animations').innerText = '当前模型支持的动画：' + cfg._animationNames.join('，');
                    }else{
                        container.querySelector('#supported-animations').innerText = '当前模型支持的动画：idle（如需更多动画请更换模型）';
                    }
                });
            }
        }

        // --- 初始加载 ---
        loadConfigAndRender();
    </script>
</body>
</html> 